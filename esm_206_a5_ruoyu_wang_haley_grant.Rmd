---
title: "ESM 206 Assignment 5"
author: "Ruoyu Wang & Haley Grant"
date: "11/22/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(tidyverse)
library(janitor)
library(ggbeeswarm)
library(car)
library(kableExtra)
library(janitor)
library(broom)
library(ggpubr)
library(DT)
library(viridisLite)
library(effsize)
```

![](Dicamptodon_tenebrosus_2.JPG)
Photo by Jeffrey Marsten. [Wikipedia](https://commons.wikimedia.org/wiki/File:Dicamptodon_tenebrosus_2.JPG).

#### Introduction

#### Data and Methods

#### Results

Results A: Visually compare annual salamander counts in old growth (OG) and clear cut (CC) sections of Mack Creek. 

```{r}

# Read in data

mack_creek_df <- read_csv("mack_creek_vertebrates.csv") %>% 
  clean_names()

```

```{r} 

# Data wrangling

mack_creek_a <- mack_creek_df %>% 
  filter(year > 1992) %>%
  filter(species == "DITE") %>% 
  group_by(year, section) %>% 
  summarize(annual_count <- sum(!is.na(species))) %>% 
  rename(total_count = "annual_count <- sum(!is.na(species))")

```

```{r}

# Create a finalized graph

ggplot(mack_creek_a, aes(x = year, y = total_count, color = section)) +
  geom_point(alpha = 0.5) +
  geom_line(alpha = 0.3) +
  geom_smooth(method = "lm",
              size = 0.6,
              alpha = 0) +
  theme_light() +
  labs(title = "Annual salamander counts in old growth vs. clear cut sections of Mack Creek",
       x = "Year",
       y = "Total Count") 
```


```{r ruoyu_result_a}
# Find the counts of pacific giant salamander at OG and CC
salam_count <- mack_creek_df %>% 
  filter(species == "DITE") %>% 
#  filter(!notes == "Recap") %>% whether to minus these data or not
  group_by(year, section) %>% 
  summarize(
    count = n()
  )

# visualize the results
ggplot(data = salam_count)+
  geom_col(position = "dodge", 
           aes(x = year, y = count, fill = section), 
           alpha = 0.8,
           width = 0.8)+
  geom_line(aes(x = year, y = count, color = section))
```

##### Results B

Table of 2017 salamander counts by channel classification (pool, cascades and side-channel) in old growth (OG) and clear cut (CC) sections of Mack Creek.

Results B: Table of 2017 salamander counts by channel classification (pool, cascades and side-channel) in old growth (OG) and clear cut (CC) sections of Mack Creek.


```{r}
# Data wrangling

mack_creek_b <- mack_creek_df %>% 
  filter(year == 2017) %>% 
  filter(species == "DITE") %>% 
  filter(unittype %in% c("C", "SC", "P")) %>% 
  select("year", "section", "unittype", "species") %>% 
  group_by(year, section, unittype) %>% 
  summarise(count = sum(!is.na(species))) %>%
  group_by(year) %>% 
  mutate(proportion = round(count/sum(count), digits = 2))
```

```{r}
# Make a table

mack_creek_b %>% 
  kable(col.names = c("Year",
  "Section", 
                     "Channel",
                     "Count",
                     "Proportion")) %>% 
  kable_styling(bootstrap_options = "striped", 
                full_width = F,
                position = "left"
                ) %>% 
  add_header_above(c("Salamander counts by channel classification" = 5))
```


```{r ruoyu_result_b}
# find the counts of 
salam_channel_count <- mack_creek_df %>% 
  filter(unittype %in% c("C", "P", "SC")) %>% 
  filter(species == "DITE") %>% 
  filter(year == "2017") %>% 
  group_by(unittype, section) %>% 
  summarize(
    count = n()
  )

channel_section_table <- salam_channel_count %>% 
  pivot_wider(names_from = unittype, values_from = count) 

channel_section_props <- channel_section_table %>% 
  janitor::adorn_percentages(denominator = "row") %>% 
  # not sure the denomincator should be the column or the row
  adorn_pct_formatting(digits = 0) %>% 
  adorn_ns(position = "front") 

# rownames("channel_section_table$section")
# rownames<-(c("Clear Cut", "Old Growth"))
# Creat facets labels in advance.
# table_row_labs <- c("Clear Cut", "Old Growth")
# names(table_row_labs) <- c("CC","OG")

#rowrename(channel_section_table,"CC"="Clear Cut", "OG"="Old Growth")

channel_section_props %>% 
  kable(
    col.names = c("Section", "Cascades","Pool", "Side-Channel"),
    align = "cccc"
  ) %>% 
  kable_styling(bootstrap_options = "striped", 
                full_width = F,
                position = "center") %>% 
  add_header_above(c("Salamander counts by channel and sections clasification in 2017" = 4))
```

Answer: The majority of Salamanders in 2017 were found in cascades in clear cut sections of the forrest. The next place Salamanders were found the most was in cascades in old growth forests. It appears that salamanders prefer cascades to other location types. 

##### Results C

Results C: Is there a significant difference in where in the channel Pacific giant salamanders are located (pool, cascade or side channel) between the two sections (old growth and clear cut)? 

 chi square: compare proportions

 null hypothesis: no association between variables
 alternative hypothesis: association between variables


 does forest type (OG or CC) determine what channel the salamanders live (cascade, pool, side-channel)?


 Null hypothesis: No association between channel classification and different forest sections. It is independent between the variables.



```{r}
# Chi-square test for independence

# A. First, get just a contingency table of counts we just want the four count values in a df, nothing else: 
salam_chi_counts <- channel_section_table %>% 
  select(-section)

# B. Run a chi-square test
my_salam_chi <- chisq.test(salam_chi_counts)
my_salam_chi
```

Result: the channel location and two sections are independent. 
Since p > 0.05, we retain the null hypothesis that channel locations and sampling sections are independent. In other words: "There are no significant differences in forest condition (clear cut / old growth) based on where in the channels salamanders are found ($\chi$^2^(`r my_salam_chi$parameter`) = `r round(my_salam_chi$statistic,2)`, *p* (`r round(my_salam_chi$p.value,3)`) > 0.05)."

```{r}
OG <- c(201, 45,74)
CC <- c(247, 31, 90)
df_b <- rbind(OG, CC)
colnames(df_b) <- c("Cascade", "Pool", "Side-Channel")

chisq_b <- chisq.test(df_b)

# P-value is greater than our alpha 0.05, so we fail to reject the null hypothesis. We assume there is no associated between variables. The difference between old growth and clear cut forrests didn't change the locations of salamanders.

```


Channel preference does not differ significantly for salamanders in Old Growth (OG) and Clear Cut (CC) forests ($\chi$^2^(`r chisq_b$parameter`) = `r round(chisq_b$statistic, 2)`, *p* = `r round(chisq_b$p.value, 2)`). 

Results D: Only considering creek section (OG or CC) as a variable (not further factoring by channel classification), answer: Is there a significant difference in mean weights for Pacific giant salamanders observed in the two forest sections (CC and OG) in 2017?

```{r}

# Specify the data to be tested

mack_creek_d <- mack_creek_df %>%
  filter(year == 2017) %>% 
  filter(species == "DITE") %>% 
  select(section, weight) 

```

```{r}

# Perform a t.test
# null hypothesis: means are equal (difference in means = 0)
# alternative hypothesis: means are not equal

t_test_result_d <- t.test(mack_creek_d$weight)

```

The p-value equals `r t_test_result_d$p.value`. This value is less than .05, so we can assume that the sample means are significantly different. 

```{r}

# effect size with cohen's d

cohen_d_d <- cohen.d(mack_creek_d$weight, mack_creek_d$section, na.rm = TRUE)

```

The Cohen's d test determined that there is a small effect size: `r cohen_d_d$estimate`.
 
Results E

Compare weights of Pacific giant salamanders in pools, cascades and side-channels of Mack Creek in 2017. 

```{r}

# you will not consider "section" as a factor here

mack_creek_e <- mack_creek_df %>%
  filter(year == 2017) %>% 
  filter(species == "DITE") %>% 
  filter(unittype %in% c("C","P","SC")) %>% 
  select(year, species, weight, unittype) 

```

- First, visually compare Pacific giant salamander weights between the three channel classifications. 

```{r}

# make a graph

ggplot(mack_creek_e, aes(x = unittype, y = weight)) +
  geom_beeswarm(aes(color = unittype),
              width = 0.2,
              alpha = 0.5,
              show.legend = FALSE) +
  theme_light() +
  labs(y = "Weight",
       x = "Location",
       title = "Salamander weights by location (2017)") + 
  scale_x_discrete(labels = c("C"="Cascade","P"="Pool","SC"="Side Channel"))
```

- Second, answer: is there a significant difference in mean weights for Pacific giant salamanders observed in pools vs. cascades vs. side-channels in 2017? 

```{r}

# explore data (histogram)

ggplot(mack_creek_e, aes(x = weight)) +
  geom_histogram() +
  facet_wrap(~unittype) +
  theme_light()

```

```{r}

# explore data (qq plot)

ggplot(mack_creek_e, aes(sample = weight)) +
  geom_qq() +
  facet_wrap(~unittype, scales = "free") +
  theme_light()
```

```{r}

# check variances

e_summary <- mack_creek_e %>% 
  group_by(unittype) %>% 
  summarize(
    w_mean = mean(weight, na.rm = TRUE),
    w_se = sd(weight, na.rm = TRUE) / sqrt(n()),
    w_var = var(weight, na.rm = TRUE)
  )
```

```{r}
# Levene's statistical test for equal variance:

levene_test_e <- leveneTest(weight ~ unittype, data = mack_creek_e)

# not significant, retain null hypothesis
```

```{r}
# Run one-way ANOVA to compare group means

aov_e <- aov(weight ~ unittype, data = mack_creek_e)

# there is not a significant difference among groups
```

```{r}
# run post-hoc Tukey's

post_hoc_e <- TukeyHSD(aov_e)

# none of the pair-wise functions are significantly different
```

```{r}
# reporting outcomes

aov_e_outcomes <- unlist(summary(aov_e))

```

Mean weight did not differ significantly across all groups (one-way ANOVA with post-hoc Tukey's HSD, F`r aov_e_outcomes[1]`, `r aov_e_outcomes[2]`) = `r round(aov_e_outcomes[7], 2)`, *p* = `r round(aov_e_outcomes[9], 3)`.

- Third, describe any concerns you have about comparing means across the groups.

Mean is a measurement that is easily swayed by outliers, and it looks like the data has significant outliers. It may be more beneficial to also compare medians as well to make sure that outliers aren't affecting our result. This could be done through rank-based tests. 

#### Summary

#### References 

Gregory S. V. 2016. Aquatic Vertebrate Population Study in Mack Creek, Andrews Experimental Forest, 1987 to present. Environmental Data Initiative. https://doi.org/10.6073/pasta/5de64af9c11579266ef20da2ff32f702.








