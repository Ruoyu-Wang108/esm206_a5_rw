---
title: "ESM 206 Assignment 5"
author: "Ruoyu Wang & Haley Grant"
date: "11/22/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center")

# Attach necessary packages
library(tidyverse)
library(janitor)
library(ggbeeswarm)
library(car)
library(kableExtra)
library(janitor)
library(broom)
library(ggpubr)
library(DT)
library(viridisLite)
library(effsize)

# Read in raw data
mack_creek_df <- read_csv("mack_creek_vertebrates.csv") %>% 
  clean_names() %>% 
  filter(species == "DITE")
```

<center>

![](Dicamptodon_tenebrosus_2.JPG)

</center>

Pacific giant salamander (Dicamptodon tenebrosus). Photo by Jeffrey Marsten. [Wikipedia](https://commons.wikimedia.org/wiki/File:Dicamptodon_tenebrosus_2.JPG).

#### Introduction

This report compares the weights and abunance of Pacific giant salamanders in Mack Creek (near Blue River, Oregon). The area is composed of Clear Cut (c. 1963) and 500-year old coniferous Old Growth forrests. Data related to their locations within Mack Creek is also studied. Within the two sections of forrests, salamanders are found in Cascades, Pools and Side-Channels. We wanted to see where salamanders are found the most, and if the section of forrest- Clear Cut or Old Growth- has an affect on their location. This report does not include Salamanders found in Isolated Pools, as we were only interested in Salamanders found in the creek. Isolated pool are separated from the channel and not the focus of our study.


This report compares the weights and abundance of Pacific giant salamanders in Mack Creek (near Blue River, Oregon). The area is composed of Clear Cut and Old Growth forests. The Clear Cut sections were cut down around 1963, and the Old Growth coniferous forest is around 500 years old. Data related to their locations within Mack Creek is also studied. Within the two sections of forests, salamanders are found in Cascades, Pools and Side-Channels. Salamanders found in Isolated Pools were not included in this report, as they the pools are separated from the channel. We are only interested in salamanders found in the creek.  


#### Data and Methods

The [data set](https://portal.lternet.edu/nis/mapbrowse?packageid=knb-lter-and.4027.12) was provided by the study "Aquatic Vertebrate Population Study in Mack Creek," by authors Stanley V. Gregory and the Andrews Forest LTER Site. The study monitored populations of West Slope cutthroat trout (Onchorhyncus clarki clarki) since 1987, as well as Pacific giant salamanders (Dicamptodon tenebrosus) beginning in 1993. This report visualizes anual counts of salamanders between Clear Cut and Old Growth sections from 1987 to present to show changes in populations. We used Chi-Square tests, t-tests, as well as One-Way ANOVA tests to determine if there were significant differences in counts or weights of salamanders across sections (Clear Cut or Old Growth) or locations (Cascades, Pools or Side-Channels).      

<center>

![](mack_creek_map_3.png) 

</center>

Map of Mack Creek, Oregon. Courtesy of [Google Maps](https://www.google.com/maps/place/44°13'17.3%22N+122°10'04.8%22W/@44.8758978,-124.1058318,7.57z/data=!4m5!3m4!1s0x0:0x0!8m2!3d44.2214667!4d-122.168!5m1!1e4?hl=en-US).

#### Results

##### Results A

Visually compare annual salamander counts in old growth (OG) and clear cut (CC) sections of Mack Creek. 

```{r compare_counts_sections}
# Find the counts of pacific giant salamander at OG and CC
mack_creek_a <- mack_creek_df %>% 
# filter(!notes == "Recap") %>% whether to minus these data or not
  group_by(year, section) %>% 
  summarize(
    total_count = n()
    )

# Visualize the results
ggplot(mack_creek_a, aes(x = year, y = total_count, color = section, pch = section)) +
  geom_point() +
  geom_line(alpha = 0.3) +
  theme_light() +
  labs(x = "Year",
       y = "Total Count") 

```
***Figure. 1*** *Data: .*

##### Results B

Table of 2017 salamander counts by channel classification (pool, cascades and side-channel) in old growth (OG) and clear cut (CC) sections of Mack Creek.

Results B: Table of 2017 salamander counts by channel classification (pool, cascades and side-channel) in old growth (OG) and clear cut (CC) sections of Mack Creek.

***Table. 1*** *Summary table site groups. Data: .* 
```{r ruoyu_result_b}
# Find the counts of salamander by channel classification (pool, cascades and side-channel) in old growth (OG) and clear cut (CC) sections of Mack Creek in year 2017.
salam_channel_count <- mack_creek_df %>% 
  filter(unittype %in% c("C", "P", "SC")) %>% 
  filter(year == "2017") %>% 
  group_by(unittype, section) %>% 
  summarize(
    count = n()
  ) %>% 
  mutate(section = ifelse(
    section == "OG",
    "Old Growth",
    "Clear Cut"
  ))

# Change the dataframe into wide format.
channel_section_table <- salam_channel_count %>% 
  pivot_wider(names_from = unittype, values_from = count) 

# Calculate the propotions within the dataframe.
channel_section_props <- channel_section_table %>% 
  janitor::adorn_percentages(denominator = "row") %>% 
  # not sure the denomincator should be the column or the row
  adorn_pct_formatting(digits = 0) %>% 
  adorn_ns(position = "front") 

# Put the results in a nice kable.
channel_section_props %>% 
  kable(
    col.names = c("Section", "Cascades","Pool", "Side-Channel"),
    align = "cccc"
  ) %>% 
  kable_styling(bootstrap_options = "striped", 
                full_width = F,
                position = "center") %>% 
  add_header_above(c("Salamander counts by channel and sections classification in 2017" = 4))

```

##### Results C

Is there a significant difference in where in the channel Pacific giant salamanders are located (pool, cascade or side channel) between the two sections (old growth and clear cut)? 

We use chi square test to compare proportions.

Null hypothesis: No association between channel classification and different forest sections. It is independent between the variables.

alternative hypothesis: association between variables

```{r result_c_chi_test}

# Chi-square test for independence

# A. First, get just a contingency table of counts we just want the four count values in a df, nothing else: 
salam_chi_counts <- channel_section_table %>% 
  select(-section)

# B. Run a chi-square test
my_salam_chi <- chisq.test(salam_chi_counts)
my_salam_chi

```

Result: the channel location and two sections are independent. 
Since p > 0.05, we retain the null hypothesis that channel locations and sampling sections are independent. In other words: "There are no significant differences in forest condition (clear cut / old growth) based on where in the channels salamanders are found ($\chi$^2^(`r my_salam_chi$parameter`) = `r round(my_salam_chi$statistic,2)`, *p* (`r round(my_salam_chi$p.value,3)`) > 0.05)."

##### Results D

Only considering creek section (OG or CC) as a variable (not further factoring by channel classification), answer: Is there a significant difference in mean weights for Pacific giant salamanders observed in the two forest sections (CC and OG) in 2017?

```{r result_d}
# Specify the data to be tested
mack_creek_d <- mack_creek_df %>%
  filter(year == 2017) %>% 
  select(section, weight)

# Summary table for different sections of forest.
forest_summary_table <- mack_creek_d %>% 
  group_by(section) %>% 
  summarize(
    mean = mean(weight, na.rm = TRUE),
    sd = sd(weight, na.rm = TRUE),
    count = n(),
    se = sd(weight, na.rm = TRUE) / sqrt(n()),
    var = var(weight, na.rm = TRUE)
  )
forest_summary_table

# Visulize the two groups of data
ggplot()+
  geom_density(data = mack_creek_d,
                 aes(x = weight, 
                     fill = section,
                     color = section),
               show.legend = FALSE,
               alpha = 0.5)+
  labs(x = "Weight (kg)", y = "Count")+
  geom_vline(data = forest_summary_table,
             aes(xintercept = mean,
                 colour = section),
             linetype = "dashed",
             size = 1,
             show.legend = FALSE)
```
***Figure. 2*** *Data: .*

```{r result_d_ttest_d}

# Perform a t.test
# null hypothesis: means are equal (difference in means = 0)
# alternative hypothesis: means are not equal

t_test_result_d <- t.test(mack_creek_d$weight)

# effect size with cohen's d

cohen_d_d <- cohen.d(mack_creek_d$weight, mack_creek_d$section, na.rm = TRUE)

```

The p-value equals `r t_test_result_d$p.value`. This value is less than 0.05, so we can assume that the sample means are significantly different. 


The Cohen's d test determined that there is a small effect size: `r cohen_d_d$estimate`.
 
##### Results E

Compare weights of Pacific giant salamanders in pools, cascades and side-channels of Mack Creek in 2017. 

```{r result_e_data_wrangling}

# Only consider the channel type as a factor here
mack_creek_e <- mack_creek_df %>%
  filter(year == 2017) %>% 
  filter(unittype %in% c("C","P","SC")) %>% 
  select(weight, unittype) 

# Create a summary table
channel_summary_table <- mack_creek_e %>% 
  group_by(unittype) %>% 
  summarize(
    mean = mean(weight, na.rm = TRUE),
    sd = sd(weight, na.rm = TRUE),
    se = sd(weight, na.rm = TRUE) / sqrt(n()),
    var = var(weight, na.rm = TRUE),
    count = n()
  )

channel_summary_table
```

- First, visually compare Pacific giant salamander weights between the three channel classifications. 

```{r result_e_weights_graph}

# make a graph

ggplot(mack_creek_e, aes(x = unittype, y = weight)) +
  geom_beeswarm(aes(color = unittype),
              width = 0.2,
              alpha = 0.7,
              show.legend = FALSE) +
  theme_light() +
  labs(y = "Weight",
       x = "Location",
       subtitle = "2017") + 
  scale_x_discrete(labels = c("C"="Cascade","P"="Pool","SC"="Side Channel"))+
  geom_point(data = channel_summary_table,
             aes(x = unittype,
                 y = mean),
             size = 1,
             show.legend = FALSE)

```

- Second, answer: is there a significant difference in mean weights for Pacific giant salamanders observed in pools vs. cascades vs. side-channels in 2017? 

```{r result_e_density_graph}
# density graph

ggplot(mack_creek_e, aes(x = weight)) +
  geom_density(aes(fill = unittype, color = unittype), alpha = 0.3) +
  theme_minimal() +
  theme(legend.position = c(0.75, 0.6)) +
  geom_vline(data = channel_summary_table,
             aes(xintercept = mean,
                 colour = unittype),
             linetype = "dashed",
             size = 1,
             show.legend = FALSE)

```

```{r result_e_check_variance}

# check variances

e_summary <- mack_creek_e %>% 
  group_by(unittype) %>% 
  summarize(
    w_mean = mean(weight, na.rm = TRUE),
    w_se = sd(weight, na.rm = TRUE) / sqrt(n()),
    w_var = var(weight, na.rm = TRUE)
  )

# largest variance (Pool) (185.58), smallest variance (Side-Channel) (68.31)
```

```{r result_e_levene_test}
# Levene's statistical test for equal variance:

levene_test_e <- leveneTest(weight ~ unittype, data = mack_creek_e)

# not significant, retain null hypothesis
```

```{r result_e_anova}
# Run one-way ANOVA to compare group means

# null hypothesis: no significant difference across groups
# alternative hypothesis: significant difference across groups

aov_e <- aov(weight ~ unittype, data = mack_creek_e)

# There is significant difference in means across groups.
```

```{r result_e_tukey}
# run post-hoc Tukey's

post_hoc_e <- TukeyHSD(aov_e)

# SC-P is significantly different. 
```

```{r result_e_report_outcomes}
# reporting outcomes

aov_e_outcomes <- unlist(summary(aov_e))

```

Of the three groups, mean salamander weight differed significantly between side-channels and pools (one-way ANOVA with post-hoc Tukey's HSD, F(`r aov_e_outcomes[1]`, `r aov_e_outcomes[2]`) = `r round(aov_e_outcomes[7],2)`, *p* = `r round(aov_e_outcomes[9],3)`).

- Third, describe any concerns you have about comparing means across the groups.

Mean is a measurement that is easily swayed by outliers, and it looks like the data has significant outliers. It may be more beneficial to also compare medians as well to make sure that outliers aren't affecting our result. This could be done through rank-based tests. 

#### Summary

#### References 

Gregory S. V. 2016. Aquatic Vertebrate Population Study in Mack Creek, Andrews Experimental Forest, 1987 to present. Environmental Data Initiative. https://doi.org/10.6073/pasta/5de64af9c11579266ef20da2ff32f702.



